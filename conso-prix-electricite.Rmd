---
title: \vspace{3in}Consommation et prix de l'électricité
author: "Vadim BERTRAND, Kassim KONE"
output:
    pdf_document
header-includes:
    \usepackage{float}
    \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, results = F)
knitr::opts_chunk$set(fig.width = 16, fig.height = 8)
```

```{r}
library(dplyr)
library(forecast)
library(ggpubr)
library(lubridate)
load("data/swap-elec.Rda")
load("data/conso-elec.Rda")
```

\newpage

\renewcommand*\contentsname{Table des matières}
\tableofcontents

\newpage

# Introduction

Nous avons choisi d'observer les prix de l'électricité sur le marché boursier français (données SWAP) et la consommation électrique en France. Les données que nous utilisons proviennent de RTE (le gestionnaire français du Réseau de Transport d'Electricité) pour la période 2015 - 2021. \
Le pas des données SWAP est horaire, tout comme celui des données de consommation.

Notre étude s'intéressera tout d'abord à la détection de tendance et de saisonnalité dans nos séries temporelles. Dans un second temps nous tenterons de proposer un modèle permettant d'estimer et de prédire convenablement ces séries. Enfin nous essaierons d'identifier un lien entre les deux séries.

# 1. Analyse de la tendance et de la saisonnalité

#### 1.1. Prix de l'électricité \

Sur la _Figure 1_ nous avons représenté les variations du prix de l'électricité entre 2015 et 2021 pour différents pas. \
Visuellement jusqu'en 2021 le prix de l'énergie semble suivre une tendance plutôt stable, avec une saisonnalité qui pourrait être mensuelle ou trimenstrielle. \
A partir de 2021 en revanche la tendance se rapproche d'une exponentielle. Peut-être que pour obtenir un modèle satisfaisant il nous faudra ne pas considérer les données de 2021. \
A la fin de l'année 2016 nous voyons qu'il y a eu de forts pics très ponctuels, uniquement visibles au pas horaire. Nous pouvons nous demander s'il y a eu des évènements particuliers à cette période.

```{r}
elec.swap.daily.df <- elec.swap.df %>%
  na.omit() %>%
  mutate(year = year(datetime)) %>%
  mutate(month = month(datetime)) %>%
  mutate(day = day(datetime)) %>%
  group_by(year, month, day) %>%
  summarise(swap = mean(swap, na.rm = T)) %>%
  ungroup()
elec.swap.monthly.df <- elec.swap.daily.df %>%
  group_by(year, month) %>%
  summarise(swap = mean(swap, na.rm = T)) %>%
  ungroup()
elec.swap.yearly.df <- elec.swap.daily.df %>%
  group_by(year) %>%
  summarise(swap = mean(swap, na.rm = T)) %>%
  ungroup()

elec.swap.hourly.ts <- ts(elec.swap.df$swap, start = c(2015, 1), 
                          freq = 365.25 * 24)
elec.swap.daily.ts <- ts(elec.swap.daily.df$swap, start = c(2015, 1), 
                         freq = 365.25)
elec.swap.monthly.ts <- ts(elec.swap.monthly.df$swap, start = c(2015, 1), 
                           freq = 12)
elec.swap.yearly.ts <- ts(elec.swap.yearly.df$swap, start = 2015, freq = 1)
```
```{r, fig.cap = "Variations du prix de l'électricité pour différents pas"}
gh <- autoplot(elec.swap.hourly.ts) +
  ylab("Prix") +
  xlab("Année") +
  ggtitle("Pas horaire") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gd <- autoplot(elec.swap.daily.ts) +
  ylab("Prix") +
  xlab("Année") +
  ggtitle("Pas journalier") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gm <- autoplot(elec.swap.monthly.ts) +
  ylab("Prix") +
  xlab("Année") +
  ggtitle("Pas mensuel") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ga <- autoplot(elec.swap.yearly.ts) +
  ylab("Prix") +
  xlab("Année") +
  ggtitle("Pas annuel") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ggarrange(gh, gd, gm, ga, nrow = 2, ncol = 2)
```

Il est possible que cette série possède plusieurs saisonnalités, aussi nous avons illustré sur la _Figure 2_ la valeur médiane pour chaque heure de la journée, chaque jour de la semaine et chaque mois de l'année. \
Nous remarquons qu'en effet trois saisonnalités semblent exister et méritent d'être considérées : horaire, hebdomadaire et mensuelle.

```{r}
elec.swap.hourly.med.df <- elec.swap.df %>%
  na.omit() %>%
  mutate(hour = hour(datetime)) %>%
  group_by(hour) %>%
  summarise(swap = median(swap, na.rm = T)) %>%
  ungroup()
elec.swap.wdaily.med.df <- elec.swap.df %>%
  na.omit() %>%
  mutate(wday = ((wday(datetime)-2)%%7)+1) %>%
  group_by(wday) %>%
  summarise(swap = median(swap, na.rm = T)) %>%
  ungroup()
elec.swap.monthly.med.df <- elec.swap.df %>%
  na.omit() %>%
  mutate(month = month(datetime)) %>%
  group_by(month) %>%
  summarise(swap = median(swap, na.rm = T)) %>%
  ungroup()
```

```{r, fig.cap = "Prix médian de l'électricité par heure, par jour de la semaine et par mois"}
gh <- ggplot() + 
  geom_line(data = elec.swap.hourly.med.df, aes(x = hour, y = swap)) +
  scale_y_continuous("Prix") +
  scale_x_continuous("Heure", breaks = elec.swap.hourly.med.df$hour,
                     labels = elec.swap.hourly.med.df$hour) +
  ggtitle("Par heure") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gd <- ggplot() + 
  geom_line(data = elec.swap.wdaily.med.df, aes(x = wday, y = swap)) +
  scale_y_continuous("Prix") +
  scale_x_continuous("Jour de la semaine", 
                     breaks = elec.swap.wdaily.med.df$wday,
                     labels = c("Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim")) +
  ggtitle("Par jour de la semaine") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gm <- ggplot() + 
  geom_line(data = elec.swap.monthly.med.df, aes(x = month, y = swap)) +
  scale_y_continuous("Prix") +
  scale_x_continuous("Mois", breaks = elec.swap.monthly.med.df$month,
                     labels = c("Jan", "Fev", "Mar", "Avr", "Mai", "Jun", 
                                "Jui", "Aou", "Sep", "Oct", "Nov", "Dec")) +
  ggtitle("Par mois") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ggarrange(gh, ggarrange(gd, gm, ncol = 2, nrow = 1), ncol = 1, nrow = 2)
```

#### 1.2. Consommation électrique \

Nous remarquons sur la _Figure 3_ que la tendance de la consommation électrique semble légèrement décroissante, mis à part 2020 qui connait une forte chute en raison du COVID-19 ; et qu'une saisonnalité se dégage : pendant les mois d'hiver la consommation augmente.

```{r}
elec.conso.daily.df <- elec.conso.df %>%
  na.omit() %>%
  mutate(year = year(datetime)) %>%
  mutate(month = month(datetime)) %>%
  mutate(day = day(datetime)) %>%
  group_by(year, month, day) %>%
  summarise(conso = mean(conso, na.rm = T)) %>%
  ungroup()
elec.conso.monthly.df <- elec.conso.daily.df %>%
  group_by(year, month) %>%
  summarise(conso = mean(conso, na.rm = T)) %>%
  ungroup()
elec.conso.yearly.df <- elec.conso.daily.df %>%
  group_by(year) %>%
  summarise(conso = mean(conso, na.rm = T)) %>%
  ungroup()

elec.conso.hourly.ts <- ts(elec.conso.df$conso, start = c(2015, 1),
                           freq = 365.25 * 24)
elec.conso.daily.ts <- ts(elec.conso.daily.df$conso, start = c(2015, 1),
                          freq = 365.25)
elec.conso.monthly.ts <- ts(elec.conso.monthly.df$conso, start = c(2015, 1),
                            freq = 12)
elec.conso.yearly.ts <- ts(elec.conso.yearly.df$conso, start = 2015, freq = 1)
```

```{r, fig.cap = "Variations de la consommation électrique pour différents pas"}
gh <- autoplot(elec.conso.hourly.ts) +
  ylab("Consommation") +
  xlab("Année") +
  ggtitle("Pas horaire") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gd <- autoplot(elec.conso.daily.ts) +
  ylab("Consommation") +
  xlab("Année") +
  ggtitle("Pas journalier") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gm <- autoplot(elec.conso.monthly.ts) +
  ylab("Consommation") +
  xlab("Année") +
  ggtitle("Pas mensuel") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ga <- autoplot(elec.conso.yearly.ts) +
  ylab("Consommation") +
  xlab("Année") +
  ggtitle("Pas annuel") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ggarrange(gh, gd, gm, ga, nrow = 2, ncol = 2)
```

De même que pour le prix nous pouvons voir sur la _Figure 4_ que trois saisonnalités peuvent être explorées.

```{r}
elec.conso.hourly.med.df <- elec.conso.df %>%
  na.omit() %>%
  mutate(hour = hour(datetime)) %>%
  group_by(hour) %>%
  summarise(conso = median(conso, na.rm = T)) %>%
  ungroup()
elec.conso.wdaily.med.df <- elec.conso.df %>%
  na.omit() %>%
  mutate(wday = ((wday(datetime)-2)%%7)+1) %>%
  group_by(wday) %>%
  summarise(conso = median(conso, na.rm = T)) %>%
  ungroup()
elec.conso.monthly.med.df <- elec.conso.df %>%
  na.omit() %>%
  mutate(month = month(datetime)) %>%
  group_by(month) %>%
  summarise(conso = median(conso, na.rm = T)) %>%
  ungroup()
```

```{r, fig.cap = "Consommation électrique médiane par heure, par jour de la semaine et par mois"}
gh <- ggplot() + 
  geom_line(data = elec.conso.hourly.med.df, aes(x = hour, y = conso)) +
  scale_y_continuous("Consommation") +
  scale_x_continuous("Heure", breaks = elec.swap.hourly.med.df$hour,
                     labels = elec.swap.hourly.med.df$hour) +
  ggtitle("Par heure") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gd <- ggplot() + 
  geom_line(data = elec.conso.wdaily.med.df, aes(x = wday, y = conso)) +
  scale_y_continuous("Consommation") +
  scale_x_continuous("Jour de la semaine", 
                     breaks = elec.swap.wdaily.med.df$wday,
                     labels = c("Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim")) +
  ggtitle("Par jour de la semaine") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
gm <- ggplot() + 
  geom_line(data = elec.conso.monthly.med.df, aes(x = month, y = conso)) +
  scale_y_continuous("Consommation") +
  scale_x_continuous("Mois", breaks = elec.swap.monthly.med.df$month,
                     labels = c("Jan", "Fev", "Mar", "Avr", "Mai", "Jun", 
                                "Jui", "Aou", "Sep", "Oct", "Nov", "Dec")) +
  ggtitle("Par mois") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
ggarrange(gh, ggarrange(gd, gm, ncol = 2, nrow = 1), ncol = 1, nrow = 2)
```

#### 1.3. Premiers liens \

Blabla

```{r fig.cap = "Evolution jointe du prix et de la consommation d'électricité"}
hours.c <- max(elec.conso.hourly.med.df) / max(elec.swap.hourly.med.df)
days.c <- max(elec.conso.wdaily.med.df) / max(elec.swap.wdaily.med.df)
months.c <- max(elec.conso.monthly.med.df) / max(elec.swap.monthly.med.df)

gh <- ggplot() + 
  geom_line(data = elec.swap.hourly.med.df, aes(x = hour, y = swap, 
                                                color = "Prix")) + 
  geom_line(data = elec.conso.hourly.med.df, 
            aes(x = hour, y = conso / hours.c, 
                color = "Consommation")) +
  scale_y_continuous("Prix", sec.axis = sec_axis(~ . * hours.c, 
                                                 name = "Consommation")) +
  scale_x_continuous("Heure", breaks = elec.swap.hourly.med.df$hour,
                     labels = elec.swap.hourly.med.df$hour) +
  ggtitle("Par heure") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        legend.position = "none")
gd <- ggplot() + 
  geom_line(data = elec.swap.wdaily.med.df, aes(x = wday, y = swap, 
                                               color = "Prix")) + 
  geom_line(data = elec.conso.wdaily.med.df, 
            aes(x = wday, y = conso / days.c, 
                color = "Consommation")) +
  scale_y_continuous("Prix", sec.axis = sec_axis(~ . * days.c, 
                                                 name = "Consommation")) +
  scale_x_continuous("Jour de la semaine", 
                     breaks = elec.swap.wdaily.med.df$wday,
                     labels = c("Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim")) +
  ggtitle("Par jour de la semaine") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) + 
  labs(color = "Légende")
gm <- ggplot() + 
  geom_line(data = elec.swap.monthly.med.df, aes(x = month, y = swap, 
                                                 color = "Prix")) + 
  geom_line(data = elec.conso.monthly.med.df, 
            aes(x = month, y = conso / months.c, 
                color = "Consommation")) +
  scale_y_continuous("Prix", sec.axis = sec_axis(~ . * months.c, 
                                                 name = "Consommation")) +
  scale_x_continuous("Mois", breaks = elec.swap.monthly.med.df$month,
                     labels = c("Jan", "Fev", "Mar", "Avr", "Mai", "Jun", 
                                "Jui", "Aou", "Sep", "Oct", "Nov", "Dec")) +
  ggtitle("Par mois") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) + 
  labs(color = "Légende")

ggarrange(gh, ggarrange(gd, gm, ncol = 2, nrow = 1,  
                        common.legend = T, legend = "top"), 
          ncol = 1, nrow = 2)
```

